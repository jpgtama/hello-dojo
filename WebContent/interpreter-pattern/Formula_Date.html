<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Date Formula</title>
<script type="text/javascript" src="moment.js"></script>
<script type="text/javascript">
    dojoConfig = {
        baseUrl : '/lib/dojo/',
        parseOnLoad : true,
        async : false,
        cacheBust : true,
        isDebug : true,
        packages : [
            {
                name : 'dgrid',
                location : '../dgrid'
            },
            {
                name : 'dstore',
                location : '../dstore'
            },
            {
                name : 'put-selector',
                location : '../put-selector'
            },
            {
                name : 'xstyle',
                location : '../xstyle'
            },
            {
                name : 'app',
                location : '/demo'
            }
        ]
    };
</script>
<script src="/lib/dojo/dojo.js"></script>
<link rel="stylesheet" href="/lib/dojo/resources/dojo.css" />
<link rel="stylesheet" href="/lib/dijit/themes/dijit.css" />
<link rel="stylesheet" href="/lib/dijit/themes/claro/claro.css" />
<style type="text/css">
body{
	padding: 10px 100px;
}


table{
    border-spacing: 28px;
}

#ctx{
    width: 660px;
    height: 150px;
}

</style>
</head>
<body class="claro philips">

<pre>Date Formula</pre>

<table>
    <tr>
        <td>
            Please <button onclick="addFormData()">Add</button> form data:
        </td>
        <td id="formData">
        </td>
    </tr>
    <tr>
        <td>
            Please input formula:
        </td>
        <td>
            <input id="expStr" style="line-height: 30px;">
        </td>
    </tr>
    <tr>
        <td>
            Please choose unit:
        </td>
        <td>
            <select id="unit">
                <option value="year">Year</option>
                <option value="month">Month</option>
                <option value="day" selected>Day</option>
                <option value="hour">Hour</option>
                <option value="minute">Minute</option>
                <option value="second">Second</option>
            </select>
        </td>
    </tr>
   
    <tr>
        <td>
            <button onclick="calc()">Calculate</button>
        </td>
        <td>
            <div id="result"></div>
        </td>
    </tr>
   

</table>
<hr/>



<script>
	require(['dijit/form/DateTextBox', 'dojo/date/locale',
	         'dojo/dom-construct', 'dojo/string', 'dojo/_base/declare', 'dojo/domReady!'], function(DateTextBox, locale, domC, string, declare){
	    
	    var fieldNameIndex = 'a'.charCodeAt(0);
	    
	    window.addFormData = function(){
	        
	        var field = domC.toDom(string.substitute('<div class="field">  <input value="${fieldName}" class="name"/> &nbsp;=&nbsp;&nbsp;    </div>', {
	            fieldName: String.fromCharCode(fieldNameIndex++)
	        }));
	        
	        var dtbNode = domC.toDom('<input />');
	        
	        field.appendChild(dtbNode);
	        
	        $('#formData').appendChild(field);
	        
	        new DateTextBox({
	            className: 'date',
	            required: true,
	            value: '2005-12-30'
	        }, dtbNode).startup();
	        
	    }
	    
	    window.addFormData();
	    
	});

</script>









<script type="text/javascript">


function $(s){
    return document.querySelector(s);
}

function calc(){
    // get value
    var unit = $('#unit').value;
    
    var expStr = $('#expStr').value;
    
    var data = getFormData();
    
    try{
        // validate
        if(!unit){
            throw 'no unit';
        }
        
        if(!expStr){
            throw 'no formula';
        }
        
        if(!data){
            throw 'no data';
        }
        
        
        var ctx = {
            data: data,
            unit: unit
        };
        
        console.log(unit, expStr, ctx);
    
        // parse
        var cal = new Calculator(expStr);
        
        // run
        var result = cal.run(ctx);
        console.log(result);
        
        if(result.isD){
            $('#result').innerText = moment(result.value).format('M/D/YYYY');
        }else{
            $('#result').innerText = result.value + ' '+ unit;
        }
        
    }catch(e){
        $('#result').innerText = e;
        throw e;
    }
    
    
}

function getFormData(){
    var fields = $('#formData').children;
    
    var ret = {};
    
    for(var i=0;i<fields.length; i++){
        var field = fields[i];
        
        var name = field.children[0];
        var date = dijit.getEnclosingWidget(field.children[1]).get('value').getTime();
        
        ret[name.value] = date;
    }
    
    return ret;
}


function Calculator(exprStr){
    this.tokens = new Tokens(Lexer(exprStr));
    
    console.table(this.tokens.tokenArray);
    
    this.exp = getExp(this.tokens);
    
    console.log(this.exp);
    
    
    this.run = function(ctx){
        var result = this.exp.interpret(ctx);
        console.log('result: ', result);
        return result;
    }
    
    var leftTokens = this.tokens.left();
    console.log('left tokens: ', leftTokens);
    
    if(leftTokens.length > 0){
        var msg = 'wrong things: ' + leftTokens.map(function(t){return t.value}).join(',');
        throw msg;
    }
    
}


function Result(type, value){
    this.isN = type==='number';
    this.isD = type==='date';
    this.value =  value;
}


// 1.Term = <数字> | <变量> | “(”Exp”)”

// 2.Factor = Term ((“*” | “/”) Term)*

// 3.Exp = Factor ((“+” | “-”) Factor)*


function Expression(op, left, right, isNum, isVar, nv){
    this.op = op;
    this.left = left;
    this.right = right;
    this.isNum = isNum;
    this.isVar = isVar;
    this.nv = nv;
    
    this.interpret = function(ctx){
        if(this.isNum){
            return new Result('number', parseInt(this.nv));
        }else if(this.isVar){
            if(this.nv in ctx.data){
                return new Result('date', ctx.data[this.nv]);
            }else{
                throw 'no value for ' + this.nv;
            }
        }
        
        var left = this.left.interpret(ctx);
        var right = this.right.interpret(ctx);
        
        var interpretValue = null;
        
        if(this.op === '+'){
            // Date + Date is invalid
            if(left.isD && right.isD){
                throw 'Can\'t add two dates: ' + this.left.nv + ' + '+ this.right.nv;
            }
            
            if(left.isD && right.isN){
                var date = moment(left.value);
                date.add(right.value, ctx.unit);
                return new Result('date', date.valueOf());
            }
            
            if(left.isN && right.isD){
                var date = moment(right.value);
                date.add(left.value, ctx.unit);
                return new Result('date', date.valueOf());
            }
            
            if(left.isN && right.isN){
                return new Result('number', left.value + right.value);
            }
        }else if(this.op === '-'){
            // Number -  Data is invalid
            if(left.isN && right.isD){
            	throw 'Can\'t sub a number with a date' + ', '+ left.value + ' - '+ right.value;
            }
            
            if(left.isD && right.isD){
                var d1 = moment(left.value);
                var d2 = moment(right.value);
                return new Result('number', d1.diff(d2, ctx.unit));
            }
            
            if(left.isD && right.isN){
                var date = moment(left.value);
                date.subtract(right.value, ctx.unit);
                return new Result('date', date.valueOf());
            }
            
            
            if(left.isN && right.isN){
                return new Result('number', left.value - right.value);
            }
        }else if(this.op === '*'){
            // only number * number is valid
            if(left.isN && right.isN){
                return new Result('number', left.value * right.value);
            }else{
                throw 'only number * number is valid';
            }
            
        }else if(this.op === '/'){
            if(right.value === 0){
                throw 'divided by 0 error';
            }
            
         	// only number / number is valid
            if(left.isN && right.isN){
                return new Result('number', left.value / right.value);
            }else{
                throw 'only number / number is valid';
            }
        }
    }
}

function getNumber(/* Tokens */ tokens){
    var t = tokens.current();
    
    if(t && t.isN){
        var num = t.value;
        tokens.forward();
        return new Expression(null, null, null, true, null, num);
    }
}

function getVar(/* Tokens */ tokens){
    var t = tokens.current();
    
    if(t && t.isV){
        var num = t.value;
        tokens.forward();
        return new Expression(null, null, null, null, true, num);
    }
}



function getTerm(/* Tokens */ tokens){
    // Term = <数字> | <变量> | “(”Exp”)”
    var term = getNumber(tokens);
    
    if(term){
        return term;
    }
    
    
    term = getVar(tokens);
    
    if(term){
        return term;
    }
    
    var token = tokens.current();
    
    if(token && token.isLB){
        tokens.forward();
        var exp = getExp(tokens);
        
        token = tokens.current();
        if(token.isRB){
            tokens.forward();
           return exp; 
        }else{
            throw 'need RB here.';
        }
    }
}


function getFactor(tokens){
    // Factor = Term ((“*” | “/”) Term)*
    
    var factor = getTerm(tokens);
    
    
    
    while(tokens.hasNext()){
        var op = null;
        
        var token = tokens.current();
        
        if(token.isS && token.value === '*'){
            op = '*';
        }else if(token.isS && token.value === '/'){
            op = '/';
        }else{
            break;
        }
        
        if(op){
            tokens.forward();
            var term = getTerm(tokens);
            if(term){
                factor = new Expression(op, factor, term);
            }else{
                throw 'need two operands for ' + op;
            }
        }
    }

    return factor;
}

function getExp(tokens){
    // Exp = Factor ((“+” | “-”) Factor)*
    
    var exp = getFactor(tokens);
    
    
    
    while(tokens.hasNext()){
        var op = null;
        
        var token = tokens.current();
        
        if(token.isS && token.value === '+'){
            op = '+';
        }else if(token.isS && token.value === '-'){
            op = '-';
        }else{
            break;
        }
        
        if(op){
            tokens.forward();
            var factor = getFactor(tokens);
            if(factor){
                exp = new Expression(op, exp, factor);
            }else{
                throw 'need two operands for ' + op;
            }
        }
    }

    return exp;
    
}

function Tokens(tokenArray){
    this.tokenArray = tokenArray;
    
    this.index = 0;
    
    this.next = function(){
        return this.tokenArray[this.index++];
    };
    
    this.hasNext = function(){
        return this.index < this.tokenArray.length;
    };
    
    this.current = function(){
        return this.tokenArray[this.index];
    }
    
    this.forward = function(){
        this.index++;
        return this;
    }
    
    this.back = function(){
        this.index--;
        return this;
    }
    
    this.left = function(){
        var tmp = [];
        var index = this.index;
        if(index < this.tokenArray.length){
            tmp.push(this.tokenArray[index++]);
        }
        
        return tmp;
    }
}

function Token(type, value){
    // S for Symbol '+', '-', V for variables, N for number, B for ()
    this.type = type;
    this.value = value;
    
    
    if(this.type === 'S'){
        this.isS = true;
    }else if(this.type==='V'){
        this.isV = true;
    }else if(this.type==='N'){
        this.isN = true;
    }else if(this.type==='B' && this.value === '('){
        this.isB = this.isLB = true;
    }else if(this.type==='B' && this.value === ')'){
        this.isB = this.isRB = true;
    }
}



function Lexer(str){
    
    var input = new Input(str);
    
    var tokens = [];
    
    // parse
    var t = null;
    while(input.index < input.str.length){
        if((t = Symbol(input)) || (t = Variable(input))  || (t = Num(input))  || (t = Brackets(input)) ){
			tokens.push(t);	        
        }else if((t = Space(input)) ){
         	// ignore space   
        }else{
            throw 'Invalid token at: ' + input.index;
        }
    }
    
    return tokens;
}


function Input(str){
    this.index = 0;
    this.str = str;
}

function Space(/*Input*/ input){
    var c = input.str.charAt(input.index);
    if(c === ' '){
        input.index++;
        return c;
    }
}


function Brackets(/*Input*/ input){
    var c = input.str.charAt(input.index);
    if('()'.indexOf(c) !== -1){
        input.index++;
        return new Token('B', c);
    }
}

function Symbol(/*Input*/input){
    var c = input.str.charAt(input.index);
    if('+-*/'.indexOf(c) !== -1){
        input.index++;
        return new Token('S', c);
    }
}

function Variable(/*Input*/input){
    // 
    var index = input.index;
    
    var state = 0;
    while(index < input.str.length){
        var c = input.str.charAt(index);
        
        if(state === 0 && /[a-zA-Z]/.test(c)){
            state = 1;
        }else if(state ===1 && /[a-zA-Z0-9]/.test(c)){
            state = 1;
        }else{
            break;
        }

        index++;
    }
    
    // check state
    if(state === 0){
        return null;
    }else if(state !== 0 || index === input.str.length){
        // success
        var t = input.str.substring(input.index, index); 
        input.index = index;
        return new Token('V', t);
    }
}


function Num(/*Input*/input){
    // 
    var index = input.index;
    
    var state = 0;
    while(index < input.str.length){
        var c = input.str.charAt(index);
        
        if(state === 0 && /[0-9]/.test(c)){
            state = 1;
        }else if(state === 1 && /[0-9]/.test(c)){
         	state = 1;   
        }else{
            break;
        }

        index++;
    }
    
    // check state
    if(state === 0){
        return null;
    }else if(state !== 0 || index === input.str.length){
        // success
        var t = input.str.substring(input.index, index); 
        input.index = index;
        return new Token('N', t);
    }
}


	
</script>

</body>
</html>